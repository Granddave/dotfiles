#!/usr/bin/env bash

set -e

if [ ! -f CMakeLists.txt ]; then
    echo "No CMakeLists.txt file was found in this directory"
    exit 1
fi

BUILD_DIR=build
CMAKE_ARGS=(
    -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
    -GNinja
)

if [ "$1" == "-d" ]; then
    CMAKE_ARGS+=(-DCMAKE_BUILD_TYPE=Debug)
    BUILD_DIR=build_debug
    echo "Debug build"
elif [ "$1" == "-r" ]; then
    CMAKE_ARGS+=(-DCMAKE_BUILD_TYPE=Release)
    BUILD_DIR=build_release
    echo "Release build"
fi

set -x
cmake -B "./${BUILD_DIR}" -S . "${CMAKE_ARGS[@]}"
cmake --build "./${BUILD_DIR}"
set +x

if [ -f "${BUILD_DIR}/compile_commands.json" ]; then
    ln -sf "${BUILD_DIR}/compile_commands.json" .
    echo "Linked compile_commands.json to base directory"
else
    echo "compile_commands.json generation failed"
fi
